<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Live2D Viewer</title>
    <style>
        html,
        body {
            margin: 0;
            background: transparent;
            overflow: hidden;
        }

        canvas {
            position: absolute;
            pointer-events: auto;
        }
    </style>
</head>

<body style="margin: 0; overflow: hidden;">
    <script src="./js/live2dcubismcore.min.js"></script>
    <script src="./js/live2d.min.js"></script>
    <script src="./js/pixi.min.js"></script>
    <script src="./js/cubism4.min.js"></script>
    <script src="./js/qwebchannel.js"></script>
    <!--å››ä¸ªbydçš„jsæ–‡ä»¶,ç›´æ¥å°†cubismçš„sdkæ–‡ä»¶ä¸­æŠ½å‡ºæ¥,å‰©ä¸‹æ²¡æœ‰çš„ç›´æ¥cdn,å¼•ç”¨ä¸äº†å°±è‡ªå·±ä¸‹è½½æ”¾åˆ°æœ¬åœ°jsç›®å½•ä¸‹ï¼Œæˆ‘å·²ç»æ”¾å¥½äº†å°±ä¸ç”¨ç®¡äº†-->
    <script>
        let app;
        let model;
        //æŠŠè¿™ä¿©å˜é‡ç›´æ¥å…¨å±€åŒ–ï¼Œé˜²æ­¢åé¢ç›‘å¬ä¸€ç›´jsæŠ¥é”™
        //å› ä¸ºä¸€å¼€å§‹æˆ‘å°†å…¶ä½œä¸ºå±€éƒ¨å˜é‡æ¥ä½¿ç”¨ï¼Œå¯¼è‡´å…¶ä»–å‡ ä¸ªç›‘å¬ç”¨ä¸äº†ï¼ˆ â•¯â–”çš¿â–”ï¼‰
        let modelReady = false;
        //æ–°æ·»åŠ çš„å˜é‡ï¼Œç”¨æ¥åˆ¤æ–­æ¨¡å‹æ˜¯å¦åŠ è½½æˆåŠŸï¼Œ
        document.addEventListener("DOMContentLoaded", function () {
            const canvas = document.body.appendChild(document.createElement("canvas"));
            canvas.style.pointerEvents = "none";
            //é¼ æ ‡ç©¿é€äº‹ä»¶ï¼Œå¯ä»¥è®©é¼ æ ‡ç©¿é€canvasï¼Œä½†å¥ˆä½•æµ‹è¯•åcanvasä¸‹æ‰€å®šä¹‰çš„å…ƒç´ ä¾æ—§æ— æ³•å“åº”é¼ æ ‡äº‹ä»¶ï¼Œç°åœ¨ä¾æ—§æ— æ³•è§£å†³
            app = new PIXI.Application({
                view: canvas,//æŒ‡å®šPIXIä½¿ç”¨æˆ‘ä»¬åˆ›å»ºçš„canvaså…ƒç´ 
                transparent: true,//å¯ç”¨ç”»å¸ƒé€æ˜åº¦æ”¯æŒ
                backgroundAlpha: 0,//è®¾ç½®èƒŒæ™¯å®Œå…¨é€æ˜
                width: window.innerWidth,//è®¾ç½®æ¸²æŸ“å®½åº¦ä¸ºçª—å£å†…éƒ¨å®½åº¦
                height: window.innerHeight,//è®¾ç½®æ¸²æŸ“é«˜åº¦ä¸ºçª—å£å†…éƒ¨é«˜åº¦
                resolution: window.devicePixelRatio || 1,//é€‚é…é«˜DPIå±å¹•ï¼Œé˜²æ­¢æ¨¡å‹ç³Šæˆshit
                autoDensity: true//è‡ªåŠ¨è°ƒæ•´CSSå°ºå¯¸åŒ¹é…åˆ†è¾¨ç‡
            });

            const { Live2DModel } = PIXI.live2d;
            //è§£æ„èµ‹å€¼PIXI.live2dï¼Œæå‡ºLive2DModelå±æ€§ï¼Œä¼ å…¥æ¨¡å‹çš„jsonæ–‡ä»¶è·¯å¾„
            Live2DModel.from("model/Amiya/Amiya.model3.json").then(l2dModel => {
                model = l2dModel;
                model.anchor.set(0.5, 0.5);
                const scaleFactor = window.innerHeight / model.height * 0.8;
                model.scale.set(scaleFactor);
                model.x = window.innerWidth / 2;
                model.y = window.innerHeight / 2;
                app.stage.addChild(model);
                modelReady = true;
                console.log("ğŸ˜Š Live2D æ¨¡å‹åŠ è½½æˆåŠŸï¼");
                //æ¨¡å‹åœ¨çª—å£ä¸­ä½ç½®çš„è®¾ç½®
            }).catch(error => console.error("/(ã„’oã„’)/~~Live2D æ¨¡å‹åŠ è½½å¤±è´¥ï¼š", error));;

            if (typeof qt !== 'undefined') {
                new QWebChannel(qt.webChannelTransport, function (channel) {
                    window.chatController = channel.objects.chatController;
                    const tracker = channel.objects.mouseTracker;
                    //è¿™é‡Œæ˜¯åˆå§‹åŒ–WebChannelï¼Œç»‘å®šchatControllerå’ŒmouseTrackerä¸¤ä¸ªå¯¹è±¡
                    //ä¸¤ä¸ªå¯¹è±¡æ˜¯åœ¨main_window.pyä¸­registerObjectæ³¨å†Œçš„çš„ï¼Œåˆ†åˆ«ç”¨æ¥æ§åˆ¶èŠå¤©å’Œé¼ æ ‡è·Ÿè¸ª
                    chatController.response_updated.connect(function (message) {
                        if (message.startsWith("__MOUTH__:")) {
                            const value = parseFloat(message.split(":")[1]);
                            if (model?.internalModel?.coreModel) {
                                model.internalModel.coreModel.setParameterValueById("ParamMouthOpenY", value);
                            }
                        } else {
                            document.getElementById("response").textContent = message;
                        }
                        //è¿™é‡Œæ˜¯ç›‘å¬æ¨¡å‹çš„mouthOpenYå‚æ•°ï¼Œå½“æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œä¿®æ”¹æ¨¡å‹å‚æ•°ï¼Œå˜´éƒ¨å¼€å¼ ç›¸åº”å˜åŒ–
                    });

                    tracker.mouseMoved.connect((x, y) => {
                        const offsetX = (x - window.innerWidth / 2) / (window.innerWidth / 2);
                        const offsetY = -(y - window.innerHeight / 2) / (window.innerHeight / 2);
                        //è¿™é‡Œæ˜¯ç›‘å¬é¼ æ ‡ç§»åŠ¨ï¼Œæ ¹æ®é¼ æ ‡ä½ç½®ä¿®æ”¹æ¨¡å‹å‚æ•°ï¼Œçœ¼çƒè¿˜æœ‰å¤´éƒ¨è·Ÿéšé¼ æ ‡ç§»åŠ¨
                        //MouseTrackerå‡½æ•°æ¥ä¼ é€’æ›´æ–°é¼ æ ‡ç§»åŠ¨åçš„ä½ç½®å‚æ•°
                        if (model?.internalModel?.coreModel) {
                            const coreModel = model.internalModel.coreModel;
                            coreModel.setParameterValueById("ParamAngleX", offsetX * 30);
                            coreModel.setParameterValueById("ParamAngleY", offsetY * 30);
                            coreModel.setParameterValueById("ParamEyeBallX", offsetX);
                            coreModel.setParameterValueById("ParamEyeBallY", offsetY);
                        }
                    });

                    console.log("WebChannel åˆå§‹åŒ–å®Œæˆ");
                });
            }
        })
    </script>

    <div id="chat-box" style="
        position: fixed;
        bottom: 40px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 10px;
        border-radius: 12px;
        width: 80%;
        font-family: sans-serif;
        text-align: center;
        z-index: 10;">
        <div id="response">ä½ å¥½ï¼Œæˆ‘æ˜¯é˜¿ç±³å¨…ã€‚</div>
    </div>
    <!-- WebChannel ç»‘å®š -->
</body>

</html>